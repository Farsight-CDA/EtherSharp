using EtherSharp.Types;
using System.Numerics;

namespace EtherSharp.Query;

internal class QuerierUtils
{
    public static readonly EVMByteCode QuerierCode = new EVMByteCode(
        Convert.FromHexString(
            "608080604052346015576105ad908161001a8239f35b5f80fdfe608060405261000e3636610499565b61001961602061054f565b5f90619c40825b8093855182101561043357825a10610433576001602083880101515f1a92019486016021810182860190602082019085158015610429575b15610149575f80915160e81c602486015160601c61008460388801519c61007e84610534565b90610542565b9b60585a980191614e1f198901f1925a9003903d93801580610140575b6101305760016100b0866104ee565b97149182610120575b6160006100c68989610542565b1161010f57926020926100fd98979695925f95538560e81b602184015284146101065760c01b6024820152600c905b01013e610542565b915b9192610020565b506004906100f5565b505050505050945050506020915001f35b9661012a906104fc565b966100b9565b5050505050945050506020915001f35b50875a106100a1565b91929094608281999899145f146101cc5750505160601c90813b9161016d83610518565b9461600061017b8787610542565b116101be5791839161019b95936101a197956101a7575b50505050610542565b92610526565b926100ff565b5f926023918560e81b905201903c5f808080610192565b505050509450505050602001f35b9394939192909160838103610211575050506160006101ea8461050a565b1161020657916020916014935160601c3f9052019201926100ff565b505093505050602001f35b969796608c810361024b575050505061600061022c836104fc565b11610240574360c01b9052600801916100ff565b509350506020915001f35b608d81036102775750505050616000610263836104fc565b11610240574260c01b9052600801916100ff565b608e81036102a3575050505061600061028f836104fc565b11610240574560c01b9052600801916100ff565b608f81036102cc57505050506160006102bb8361050a565b11610240573a9052602001916100ff565b609081036102f557505050506160006102e48361050a565b1161024057489052602001916100ff565b9697966096810361032b5750505061600061030f8461050a565b1161020657916020916014935160601c319052019201926100ff565b9697969192909160a0810361035e575050505061600061034a836104fc565b11610240574660c01b9052600801916100ff565b9297939493919260aa03610425575f9182915160e81c98896046600161039d602485015160e81c9561007e876103986027890151976104db565b610542565b9c806047860188f09401010191614e1f195a01f1903d9180158061041c575b61040e576103c9836104ee565b946160006103d78787610542565b116103ff576103f9959493925f92602492538360e81b6021820152013e610542565b916100ff565b50505050945050506020915001f35b505050945050506020915001f35b50855a106103bc565b5f80fd5b5060018614610058565b945050506020915001f35b634e487b7160e01b5f52604160045260245ffd5b6040519190601f01601f1916820167ffffffffffffffff81118382101761047857604052565b61043e565b67ffffffffffffffff811161047857601f01601f191660200190565b9190916104ad6104a88261047d565b610452565b928184528111610425576020815f92838387013784010152565b634e487b7160e01b5f52601160045260245ffd5b60260190816026116104e957565b6104c7565b60040190816004116104e957565b90600882018092116104e957565b90602082018092116104e957565b60030190816003116104e957565b90601482018092116104e957565b60370190816037116104e957565b919082018092116104e957565b9061055c6104a88361047d565b828152809261056d601f199161047d565b019060203691013756fea264697066735822122047551f7f3c27e016d39a955728034d5a6d1f661ded26ee17ddaa20abd4867cfc64736f6c634300081e0033"
        )
    );

    public static byte[] EncodeCalls(IEnumerable<IQuery> queries, int maxPayloadSize, out int encodedCallCount, out BigInteger ethValue)
    {
        ethValue = 0;
        int dataLength = 0;
        int callCount = 0;

        foreach(var queryable in queries)
        {
            int newDataLength = dataLength + queryable.CallDataLength;

            if(newDataLength + QuerierCode.Length + 2 > maxPayloadSize)
            {
                break;
            }

            dataLength = newDataLength;
            callCount++;
            ethValue += queryable.EthValue;
        }

        encodedCallCount = callCount;

        byte[] arr = new byte[dataLength];
        var buffer = arr.AsSpan();

        foreach(var queryable in queries)
        {
            if(callCount == 0)
            {
                break;
            }

            queryable.Encode(buffer);
            buffer = buffer[queryable.CallDataLength..];
            callCount--;
        }

        return arr;
    }
}
