using EtherSharp.Numerics;
using EtherSharp.Types;
using System.Buffers;
using System.Buffers.Binary;

namespace EtherSharp.Query;

internal class QuerierUtils
{
    public static readonly EVMByteCode LondonQuerierCode = new EVMByteCode(
        Convert.FromHexString(
            "6102a56100106000396102a56000f3fe61c35061d6d890600436106102a05760003560e01c6004926000926000945b368110610035575b505050821161003157505b6000f35b9091949383851161029c5750836001823560001a9201918060001461024657806001146101e057806002146101805780600a146101585780600b14610140578060141461012f578060151461011e578060161461010d57806017146100fc57806018146100ee57806019146100e05780601e146100c8576028146100b857600080fd5b6020905a815201945b919061001e565b506020906014833560601c93019231815201946100c1565b5060209048815201946100c1565b506020903a815201946100c1565b506008904560c01b815201946100c1565b506008904260c01b815201946100c1565b506008904360c01b815201946100c1565b506008904660c01b815201946100c1565b506020906014833560601c9301923f815201946100c1565b5060006014833560601c930192803b9182918260e81b855260038501903c60030101946100c1565b50600080833560f01c600285013560e81c9060256005870135960182820190818188370195818685f091860191885a03f1865a108115166101d95781533d60e81b60018201523d6000600483013e3d60040101946100c1565b5094610026565b50813560e81c600080600385013560601c9284816037601789013598018181843701965a95895a03f1905a900390875a1081151661023e5782533d60e01b600183015260c01b60058201523d6000600d83013e3d600d0101946100c1565b505094610026565b50600080833560e81c83600386013560601c9582603760178301359201818185370196885a03f1865a108115166102955781533d60e81b60018201523d6000600483013e3d60040101946100c1565b5094610026565b6000f35b600080fd"
        )
    );

    public static readonly EVMByteCode CancunQuerierCode = new EVMByteCode(
        Convert.FromHexString(
            "61029561000e5f396102955ff3fe61c35061d6d89060043610610291575f3560e01c6004925f925f945b368110610031575b505050821161002e57505b5ff35b9091949383851161028e575083600182355f1a920191805f1461023a57806001146101d657806002146101785780600a146101515780600b1461013957806014146101285780601514610117578060161461010657806017146100f557806018146100e757806019146100d95780601e146100c1576028146100b1575f80fd5b6020905a815201945b919061001b565b506020906014833560601c93019231815201946100ba565b5060209048815201946100ba565b506020903a815201946100ba565b506008904560c01b815201946100ba565b506008904260c01b815201946100ba565b506008904360c01b815201946100ba565b506008904660c01b815201946100ba565b506020906014833560601c9301923f815201946100ba565b505f6014833560601c930192803b9182918260e81b855260038501903c60030101946100ba565b505f80833560f01c600285013560e81c9060256005870135960182820190818188370195818685f091860191885a03f1865a108115166101cf5781533d60e81b60018201523d5f600483013e3d60040101946100ba565b5094610023565b50813560e81c5f80600385013560601c9284816037601789013598018181843701965a95895a03f1905a900390875a108115166102325782533d60e01b600183015260c01b60058201523d5f600d83013e3d600d0101946100ba565b505094610023565b505f80833560e81c83600386013560601c9582603760178301359201818185370196885a03f1865a108115166102875781533d60e81b60018201523d5f600483013e3d60040101946100ba565b5094610023565b5ff35b5f80fd"
        )
    );

    public static byte[] EncodeCalls(EVMByteCode querierCode, IEnumerable<IQuery> queries, int maxPayloadSize, int maxResultSize,
        out int payloadSize, out int encodedCallCount, out UInt256 ethValue)
    {
        ethValue = 0;
        payloadSize = 4;
        int callCount = 0;

        foreach(var queryable in queries)
        {
            int newDataLength = payloadSize + queryable.CallDataLength;

            if(newDataLength + querierCode.Length + 2 > maxPayloadSize)
            {
                break;
            }

            payloadSize = newDataLength;
            callCount++;
            ethValue += queryable.EthValue;
        }

        encodedCallCount = callCount;

        byte[] arr = ArrayPool<byte>.Shared.Rent(payloadSize);
        arr.AsSpan(0, payloadSize).Clear();

        BinaryPrimitives.WriteUInt32BigEndian(arr.AsSpan(0, 4), (uint) maxResultSize);

        var buffer = arr.AsSpan(4);

        foreach(var queryable in queries)
        {
            if(callCount == 0)
            {
                break;
            }

            queryable.Encode(buffer);
            buffer = buffer[queryable.CallDataLength..];
            callCount--;
        }

        return arr;
    }
}
