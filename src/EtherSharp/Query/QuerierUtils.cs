using EtherSharp.Numerics;
using EtherSharp.Types;
using System.Buffers;
using System.Buffers.Binary;

namespace EtherSharp.Query;

internal class QuerierUtils
{
    public static readonly EVMByteCode LondonQuerierCode = new EVMByteCode(
        Convert.FromHexString(
            "6102906100106000396102906000f3fe61c35061d6d8906004361061028b579060003560e01c6004916000926000945b368210610036575b505050821161003257505b6000f35b909194938385116102875750836001833560001a9301928060001461023157806001146101cb578060021461016b5780600a146101435780600b1461012b578060141461011a578060151461010957806016146100f857806017146100e757806018146100d957806019146100cb57601e146100b157600080fd5b6020906014843560601c94019331815201945b919061001f565b5060209048815201946100c4565b506020903a815201946100c4565b506008904560c01b815201946100c4565b506008904260c01b815201946100c4565b506008904360c01b815201946100c4565b506008904660c01b815201946100c4565b506020906014843560601c9401933f815201946100c4565b5060006014843560601c940193803b9182918260e81b855260038501903c60030101946100c4565b50600080843560f01c600286013560e81c9060256005880135970182820190818188370196818685f091860191875a03f1865a108115166101c45781533d60e81b60018201523d6000600483013e3d60040101946100c4565b5094610027565b50823560e81c600080600386013560601c928481603760178a013599018181843701975a95885a03f1905a900390875a108115166102295782533d60e01b600183015260c01b60058201523d6000600d83013e3d600d0101946100c4565b505094610027565b50600080843560e81c83600387013560601c9682603760178301359201818185370197875a03f1865a108115166102805781533d60e81b60018201523d6000600483013e3d60040101946100c4565b5094610027565b6000f35b600080fd"
        )
    );

    public static readonly EVMByteCode CancunQuerierCode = new EVMByteCode(
        Convert.FromHexString(
            "61028061000e5f396102805ff3fe61c35061d6d8906004361061027c57905f3560e01c6004915f925f945b368210610032575b505050821161002f57505b5ff35b90919493838511610279575083600183355f1a930192805f1461022557806001146101c157806002146101635780600a1461013c5780600b146101245780601414610113578060151461010257806016146100f157806017146100e057806018146100d257806019146100c457601e146100aa575f80fd5b6020906014843560601c94019331815201945b919061001c565b5060209048815201946100bd565b506020903a815201946100bd565b506008904560c01b815201946100bd565b506008904260c01b815201946100bd565b506008904360c01b815201946100bd565b506008904660c01b815201946100bd565b506020906014843560601c9401933f815201946100bd565b505f6014843560601c940193803b9182918260e81b855260038501903c60030101946100bd565b505f80843560f01c600286013560e81c9060256005880135970182820190818188370196818685f091860191875a03f1865a108115166101ba5781533d60e81b60018201523d5f600483013e3d60040101946100bd565b5094610024565b50823560e81c5f80600386013560601c928481603760178a013599018181843701975a95885a03f1905a900390875a1081151661021d5782533d60e01b600183015260c01b60058201523d5f600d83013e3d600d0101946100bd565b505094610024565b505f80843560e81c83600387013560601c9682603760178301359201818185370197875a03f1865a108115166102725781533d60e81b60018201523d5f600483013e3d60040101946100bd565b5094610024565b5ff35b5f80fd"
        )
    );

    public static byte[] EncodeCalls(EVMByteCode querierCode, IEnumerable<IQuery> queries, int maxPayloadSize, int maxResultSize,
        out int payloadSize, out int encodedCallCount, out UInt256 ethValue)
    {
        ethValue = 0;
        payloadSize = 4;
        int callCount = 0;

        foreach(var queryable in queries)
        {
            int newDataLength = payloadSize + queryable.CallDataLength;

            if(newDataLength + querierCode.Length + 2 > maxPayloadSize)
            {
                break;
            }

            payloadSize = newDataLength;
            callCount++;
            ethValue += queryable.EthValue;
        }

        encodedCallCount = callCount;

        byte[] arr = ArrayPool<byte>.Shared.Rent(payloadSize);
        arr.AsSpan(0, payloadSize).Clear();

        BinaryPrimitives.WriteUInt32BigEndian(arr.AsSpan(0, 4), (uint) maxResultSize);

        var buffer = arr.AsSpan(4);

        foreach(var queryable in queries)
        {
            if(callCount == 0)
            {
                break;
            }

            queryable.Encode(buffer);
            buffer = buffer[queryable.CallDataLength..];
            callCount--;
        }

        return arr;
    }
}
