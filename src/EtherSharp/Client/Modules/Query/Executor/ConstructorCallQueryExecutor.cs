using EtherSharp.ABI.Types;
using EtherSharp.Client.Services.Subscriptions;
using EtherSharp.RPC.Modules.Eth;
using EtherSharp.Types;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Logging;

namespace EtherSharp.Client.Modules.Query.Executor;

public class ConstructorCallQueryExecutor(IEthRpcModule ethRpcModule, IServiceProvider provider) : IQueryExecutor
{
    private readonly static byte[] _querierBytecode = Convert.FromHexString(
        "608060405234610095576107b980380380610019816100ad565b928339810190602081830312610095578051906001600160401b038211610095570181601f820112156100955780519061005a610055836100d7565b6100ad565b9282845260208383010111610095575f5b82811061008057835f6020858301015261013e565b8060208092840101518282870101520161006b565b5f80fd5b634e487b7160e01b5f52604160045260245ffd5b6040519190601f01601f191682016001600160401b038111838210176100d257604052565b610099565b6001600160401b0381116100d257601f01601f191660200190565b156100f957565b60405162461bcd60e51b815260206004820152601560248201527f517565726965722063616c6c20726576657274656400000000000000000000006044820152606490fd5b6040516105f18082016001600160401b038111838210176100d25782916101c8833903905ff080156101bc5781515f91829190602085019083906001600160a01b03165af13d156101b1576101a93d9161019a610055846100d7565b9283523d5f602085013e6100f2565b602081519101f35b6101a96060916100f2565b6040513d5f823e3d90fdfe608080604052346015576105d7908161001a8239f35b5f80fdfe60806040526004361015610019575b34156101fd575b5f80fd5b5f3560e01c6361f8b70f0361000e57346100155760203660031901126100155760043567ffffffffffffffff811161001557366023820112156100155761006a903690602481600401359101610122565b6020815191015ff080156100155760209073ffffffffffffffffffffffffffffffffffffffff60405191168152f35b634e487b7160e01b5f52604160045260245ffd5b6040519190601f01601f1916820167ffffffffffffffff8111838210176100d357604052565b610099565b67ffffffffffffffff81116100d357601f01601f191660200190565b919091610108610103826100d8565b6100ad565b928184528111610015576020815f92838387013784010152565b929192610131610103836100d8565b938285528282011161001557815f926020928387013784010152565b634e487b7160e01b5f52601160045260245ffd5b600901908160091161016f57565b61014d565b600401908160041161016f57565b906008820180921161016f57565b906020820180921161016f57565b600301908160031161016f57565b906015820180921161016f57565b601801908160181161016f57565b9190820180921161016f57565b906101e2610103836100d8565b82815280926101f3601f19916100d8565b0190602036910137565b361561059f5761020d36366100f4565b6102186160206101d5565b5f9162030d40835b825181101561059757815a1061059757808301946020860191818601906020820193610250815160f81c60ff1690565b608081116103005750885f92836038610280602483965160e01c95015160601c9361027a866101ba565b906101c8565b9c01916201869f195a01f1903d918015806102f7575b6102ea576102a383610174565b946160006102b187876101c8565b116102dc576102d3959493925f92602492538360e81b6021820152013e6101c8565b915b9193610220565b505050509450505050602001f35b5050509450505050602001f35b50855a10610296565b9493929196989050608285145f1461037c5760219192939450015160601c90813b9161032b8361019e565b9461600061033987876101c8565b116102dc57918391610359959361035f9795610365575b505050506101c8565b926101ac565b936102d5565b5f926023918560e81b905201903c5f808080610350565b9193608381036103be57505061600061039484610190565b116103b357916020916021601594015160601c3f9052019201936102d5565b505093505050602001f35b608c81036103f9575050506160006103d583610182565b116103ef576001916008914360c01b9052019201936102d5565b5093505050602001f35b608d810361042a5750505061600061041083610182565b116103ef576001916008914260c01b9052019201936102d5565b608e810361045b5750505061600061044183610182565b116103ef576001916008914560c01b9052019201936102d5565b608f81036104895750505061600061047283610190565b116103ef576001916020913a9052019201936102d5565b609681036104be57505061600061049f84610190565b116103b357916020916021601594015160601c319052019201936102d5565b60a081036104ef575050506160006104d583610182565b116103ef576001916008914660c01b9052019201936102d5565b919795929392909160aa03610015575f6105288982602961052d8296602161027a9f015160e01c9e8f602587015160e01c978891610161565b6101c8565b9c8082850184f0930101916201869f195a01f1903d9180158061058e575b6102ea5761055883610174565b9461600061056687876101c8565b116102dc57610588959493925f92602492538360e81b6021820152013e6101c8565b916102d5565b50855a1061054b565b505050602001f35b00fea2646970667358221220c1b3979d8e334257c8961788eb6dd9f0c4fac24ce4269828d8b647dd356d34eb64736f6c634300081e0033"
    );
    private const int MAX_PAYLOAD_SIZE = 1024 * 1024; //1MB

    private readonly IEthRpcModule _ethRpcModule = ethRpcModule;
    private readonly ILogger? _logger = provider.GetService<ILoggerFactory>()?.CreateLogger<SubscriptionsManager>();

    public async Task<TQuery> ExecuteQueryAsync<TQuery>(IQuery<TQuery> query, TargetBlockNumber targetBlockNumber, CancellationToken cancellationToken)
    {
        Span<byte> buffer = [];
        byte[][] outputs = new byte[query.Queries.Count][];
        int requestCount = 0;

        for(int i = 0; i < query.Queries.Count; i++)
        {
            var q = query.Queries[i];
            if(buffer.Length == 0)
            {
                requestCount++;
                string payload = $"0x{Convert.ToHexString(EncodeCalls(query.Queries.Skip(i)))}";
                var callResult = await _ethRpcModule.CallAsync(
                    Address.Zero,
                    null!,
                    null,
                    null,
                    0,
                    payload,
                    targetBlockNumber,
                    cancellationToken
                );

                byte[] output = callResult.Unwrap(Address.Zero);

                if(output.Length == 0)
                {
                    throw new InvalidOperationException("Call is too expensive to be executed within batch");
                }

                buffer = output.AsSpan();
            }

            int sliceLength = q.ParseResultLength(buffer);
            byte[] sliceData = buffer[0..sliceLength].ToArray();
            outputs[i] = sliceData;
            buffer = buffer[sliceLength..];
        }

        _logger?.LogTrace("Batch query processing completed using {requests} request(s)", requestCount);

        if(requestCount > 1)
        {
            _logger?.LogDebug("Batch query processing too expensive, required {requests} requests", requestCount);
        }

        return query.ReadResultFrom(outputs);
    }

    private static byte[] EncodeCalls(IEnumerable<IQuery> queries)
    {
        int dataLength = 0;
        int callCount = 0;

        foreach(var queryable in queries)
        {
            dataLength += queryable.CallDataLength;
            callCount++;

            if(dataLength > MAX_PAYLOAD_SIZE)
            {
                break;
            }
        }

        byte[] arr = new byte[dataLength + _querierBytecode.Length + 64];
        var buffer = arr.AsSpan();

        _querierBytecode.CopyTo(buffer);
        buffer = buffer[_querierBytecode.Length..];
        AbiTypes.BigInteger.EncodeInto(32, true, buffer[0..32]);
        AbiTypes.BigInteger.EncodeInto(dataLength, true, buffer[32..64]);
        buffer = buffer[64..];

        foreach(var queryable in queries)
        {
            if(callCount == 0)
            {
                break;
            }

            queryable.Encode(buffer);
            buffer = buffer[queryable.CallDataLength..];
            callCount--;
        }

        return arr;
    }
}
