# AGENTS.md

Guidance for coding agents working in this repository.

## Scope

- Applies to the full repository rooted at `G:\Farsight\EtherSharp`.
- Prefer minimal, targeted changes that match existing patterns.
- Do not edit generated artifacts unless explicitly requested.

## Project layout

- `src/EtherSharp` - main runtime library (`net10.0`).
- `src/EtherSharp.Generator` - Roslyn incremental source generator (`netstandard2.0`).
- `src/EtherSharp.ERC` - packaged ERC interfaces that consume the generator.
- `tests` - xUnit tests (`EtherSharp.Tests.csproj`).
- `bench` - BenchmarkDotNet project (`EtherSharp.Bench.csproj`).
- `.github/workflows/test-and-publish-to-nuget.yml` - CI build/test/pack/publish flow.
- `.editorconfig` - primary style and naming rules.

## Toolchain and environment

- .NET SDK: `10.x` (see CI workflow).
- Language: C# with nullable enabled and implicit usings enabled.
- Test framework: xUnit.
- Analyzer/style enforcement runs in build (`EnforceCodeStyleInBuild=True`).

## Build, lint, test, and pack commands

Run from repository root unless noted.

### Restore

- `dotnet restore`
- Full clean restore when dependency cache issues occur:
- `dotnet restore --no-cache`

### Build

- Build all projects: `dotnet build`
- Build Release without restore: `dotnet build --configuration Release --no-restore`
- Build single project:
- `dotnet build src/EtherSharp/EtherSharp.csproj`
- `dotnet build src/EtherSharp.Generator/EtherSharp.Generator.csproj`
- `dotnet build src/EtherSharp.ERC/EtherSharp.ERC.csproj`

### Lint / static analysis

- No standalone linter config is present; use build as the lint gate.
- Recommended lint-equivalent command:
- `dotnet build --configuration Release --no-restore`
- Optional formatting check (if available in local SDK):
- `dotnet format --verify-no-changes`

### Tests

- Run all tests: `dotnet test`
- Run tests in Release: `dotnet test --configuration Release`
- Run one test project:
- `dotnet test tests/EtherSharp.Tests.csproj`

### Run a single test (important)

- Run one test method:
- `dotnet test tests/EtherSharp.Tests.csproj --filter "FullyQualifiedName~EtherSharp.Tests.ABI.Encoder.AddressAbiEncoderTests.Should_Match_Null_Address_Output"`
- Run one test class:
- `dotnet test tests/EtherSharp.Tests.csproj --filter "FullyQualifiedName~EtherSharp.Tests.ABI.Encoder.AddressAbiEncoderTests"`
- Run by method name contains:
- `dotnet test tests/EtherSharp.Tests.csproj --filter "Name~Should_Match_Null_Address_Output"`
- Run by namespace segment:
- `dotnet test tests/EtherSharp.Tests.csproj --filter "FullyQualifiedName~EtherSharp.Tests.ABI.Decoder"`

### Coverage

- `coverlet.collector` is referenced; collect coverage via:
- `dotnet test tests/EtherSharp.Tests.csproj --collect:"XPlat Code Coverage"`

### Packaging

- Pack all packable projects: `dotnet pack --configuration Release --output ./nupkgs`
- Pack without rebuild: `dotnet pack --configuration Release --no-build --output ./nupkgs`
- Pack generator explicitly:
- `dotnet pack src/EtherSharp.Generator/EtherSharp.Generator.csproj --configuration Release`

### Benchmarks

- Run benchmarks project:
- `dotnet run --project bench/EtherSharp.Bench.csproj -c Release`

## CI behavior to mirror locally

From `.github/workflows/test-and-publish-to-nuget.yml`:

- Build generator first in Release and pack it.
- Restore solution dependencies.
- Run `dotnet test`.
- Build Release with `--no-restore`.
- Pack Release artifacts to `./nupkgs`.

## Generated code and templates

- `src/EtherSharp` contains `.tt` templates with generated `.cs` outputs.
- `src/EtherSharp.Generator` emits `*.generated.cs` at compile time.
- Prefer editing source templates or generator logic, not generated outputs.
- If a generated file must change, update its origin (`.tt` or generator writer).

## Code style rules (from `.editorconfig`)

### Formatting and layout

- Indentation: 4 spaces, no tabs.
- C# namespaces must be file-scoped.
- Braces are required (`csharp_prefer_braces=true:error`).
- `using` directives belong outside namespace declarations.
- Keep `using` directives in a single group (no blank-line grouping).
- Do not force `System.*` usings to the top.

### Types and nullability

- Nullable reference types are enabled; annotate and handle null explicitly.
- Use `var` when type is apparent or elsewhere; avoid for built-in types when not apparent.
- Favor predefined type keywords for locals/parameters/members (`int`, `string`).
- Prefer pattern matching and null-propagation where it improves clarity.

### Naming conventions

- Types, public members, and methods: PascalCase.
- Interfaces: `I` prefix (for example `IEtherSigner`).
- Parameters and local variables: camelCase.
- Non-public fields: `_camelCase`.
- Type parameters: `T` prefix.
- Constants: `ALL_UPPER`.

### Expression and API style

- Expression-bodied members are common and preferred for simple members.
- Prefer object/collection initializers where they improve readability.
- Prefer throw expressions and concise guard clauses.
- Prefer tuple and deconstruction conveniences when clear.

## Imports and dependencies

- Keep imports minimal and remove unused usings.
- Prefer existing project dependencies over adding new packages.
- If adding a dependency, justify it in PR/commit notes and keep versions explicit.

## Error handling patterns

- Validate inputs early (for example `ArgumentNullException.ThrowIfNull`).
- Throw specific exceptions that match domain context (`RPCException`, `CallRevertedException` family).
- Preserve useful diagnostic context in exception messages.
- Use Try* patterns (`TrySign`, `TryHashData`) where failure is expected and non-exceptional.
- Avoid swallowing exceptions; either handle meaningfully or propagate.

## Testing conventions

- xUnit attributes: `[Fact]` is the default in this codebase.
- Test naming commonly follows `Should_*` style.
- Keep tests deterministic and focused on one behavior.
- Prefer explicit expected values for ABI encode/decode byte-level tests.

## Performance-oriented patterns to preserve

- Existing code uses spans and `stackalloc` in hot paths.
- Avoid unnecessary allocations in encoding/decoding and crypto code.
- Preserve zero-copy patterns unless correctness requires otherwise.

## Scripts and local release workflow

- Windows batch scripts in `scripts/` are tailored to local maintainer paths.
- Treat these as maintainer utilities, not cross-machine automation.
- Prefer portable `dotnet` commands in docs/PR instructions.

## Cursor and Copilot rules

- No `.cursorrules` file found.
- No `.cursor/rules/` directory found.
- No `.github/copilot-instructions.md` file found.
- If any of these files are later added, treat them as higher-priority agent instructions.

## Practical agent checklist

- Restore, build, and test only what is needed for your change scope.
- For source-generator or ABI surface changes, run full `dotnet test`.
- Keep edits small, style-compliant, and nullable-safe.
- Avoid editing generated files directly.
- Document any non-obvious tradeoffs in PR/commit notes.
